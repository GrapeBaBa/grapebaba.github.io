<!doctype html><html lang=en-us><head><title>Databend pipeline executor notes | Grapebaba's Home</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Pipeline Executor 🔗Executor Tasks 🔗struct ExecutorTasks { tasks_size: usize, workers_sync_tasks: Vec<VecDeque<ProcessorPtr>>, workers_async_tasks: Vec<VecDeque<ProcessorPtr>>, workers_completed_async_tasks: Vec<VecDeque<CompletedAsyncTask>>, } pub fn create(workers_size: usize) -> ExecutorTasks { let mut workers_sync_tasks = Vec::with_capacity(workers_size); let mut workers_async_tasks = Vec::with_capacity(workers_size); let mut workers_completed_async_tasks = Vec::with_capacity(workers_size); for _index in 0..workers_size { workers_sync_tasks.push(VecDeque::new()); workers_async_tasks.push(VecDeque::new()); workers_completed_async_tasks.push(VecDeque::new()); } ExecutorTasks { tasks_size: 0, workers_sync_tasks, workers_async_tasks, workers_completed_async_tasks, } }"><meta name=generator content="Hugo 0.110.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","281165273grape@gmail.com","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class=navigation><a href=/><span class=arrow>←</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a>
<a class=button href=https://grapebaba.github.io/index.xml>Subscribe</a></nav><main class=main><section id=single><h1 class=title>Databend pipeline executor notes</h1><div class=tip><time datetime="2022-05-23 20:57:38 +0800 +0800">May 23, 2022</time>
<span class=split>·</span>
<span>3106 words</span>
<span class=split>·</span>
<span>7 minute read</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#executor-tasks><code>Executor Tasks</code></a></li><li><a href=#executorworkercontext><code>ExecutorWorkerContext</code></a></li><li><a href=#executor-notify><code>Executor notify</code></a></li><li><a href=#port><code>Port</code></a></li><li><a href=#execute-graph><code>Execute Graph</code></a></li></ul></nav></div></details></aside><div class=content><h1 id=pipeline-executor><code>Pipeline Executor</code> <a href=#pipeline-executor class=anchor>🔗</a></h1><h2 id=executor-tasks><code>Executor Tasks</code> <a href=#executor-tasks class=anchor>🔗</a></h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> <span style=color:#00f>ExecutorTasks</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>tasks_size: <span style=color:#0b0;font-weight:700>usize</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>workers_sync_tasks: <span style=color:#a2f>Vec</span><span style=color:#666>&lt;</span>VecDeque<span style=color:#666>&lt;</span>ProcessorPtr<span style=color:#666>&gt;&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>workers_async_tasks: <span style=color:#a2f>Vec</span><span style=color:#666>&lt;</span>VecDeque<span style=color:#666>&lt;</span>ProcessorPtr<span style=color:#666>&gt;&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>workers_completed_async_tasks: <span style=color:#a2f>Vec</span><span style=color:#666>&lt;</span>VecDeque<span style=color:#666>&lt;</span>CompletedAsyncTask<span style=color:#666>&gt;&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>create</span>(workers_size: <span style=color:#0b0;font-weight:700>usize</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#00f>ExecutorTasks</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>workers_sync_tasks<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>Vec</span>::with_capacity(workers_size);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>workers_async_tasks<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>Vec</span>::with_capacity(workers_size);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>workers_completed_async_tasks<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>Vec</span>::with_capacity(workers_size);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>for</span><span style=color:#bbb> </span>_index<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#666>..</span>workers_size<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>workers_sync_tasks.push(VecDeque::new());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>workers_async_tasks.push(VecDeque::new());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>workers_completed_async_tasks.push(VecDeque::new());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>ExecutorTasks<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>tasks_size: <span style=color:#666>0</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>workers_sync_tasks,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>workers_async_tasks,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>workers_completed_async_tasks,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p><code>ExecutorTasks</code>按照<code>task</code>的类型，维护了每个<code>worker</code>的3种执行任务队列<code>VecDeque&lt;ProcessorPtr></code>，<code>worker</code>的编号使用<code>Vec</code>的<code>index</code>表示。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>push_task</span>(<span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self,<span style=color:#bbb> </span>worker_id: <span style=color:#0b0;font-weight:700>usize</span>,<span style=color:#bbb> </span>task: <span style=color:#00f>ExecutorTask</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>self.tasks_size<span style=color:#bbb> </span><span style=color:#666>+=</span><span style=color:#bbb> </span><span style=color:#666>1</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>debug_assert!(worker_id<span style=color:#bbb> </span><span style=color:#666>&lt;</span><span style=color:#bbb> </span>self.workers_sync_tasks.len(),<span style=color:#bbb> </span><span style=color:#b44>&#34;out of index&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>sync_queue<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self.workers_sync_tasks[worker_id];<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>debug_assert!(worker_id<span style=color:#bbb> </span><span style=color:#666>&lt;</span><span style=color:#bbb> </span>self.workers_async_tasks.len(),<span style=color:#bbb> </span><span style=color:#b44>&#34;out of index&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>async_queue<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self.workers_async_tasks[worker_id];<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>debug_assert!(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>worker_id<span style=color:#bbb> </span><span style=color:#666>&lt;</span><span style=color:#bbb> </span>self.workers_completed_async_tasks.len(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#b44>&#34;out of index&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>completed_queue<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self.workers_completed_async_tasks[worker_id];<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>match</span><span style=color:#bbb> </span>task<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>ExecutorTask::<span style=color:#a2f>None</span><span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>unreachable!(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>ExecutorTask::<span style=color:#a2f>Sync</span>(processor)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>sync_queue.push_back(processor),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>ExecutorTask::Async(processor)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>async_queue.push_back(processor),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>ExecutorTask::AsyncCompleted(task)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>completed_queue.push_back(task),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>best_worker_id</span>(<span style=color:#666>&amp;</span>self,<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>worker_id: <span style=color:#0b0;font-weight:700>usize</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#0b0;font-weight:700>usize</span> {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>for</span><span style=color:#bbb> </span>_index<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#666>..</span>self.workers_sync_tasks.len()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span>worker_id<span style=color:#bbb> </span><span style=color:#666>&gt;=</span><span style=color:#bbb> </span>self.workers_sync_tasks.len()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>worker_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>0</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>!</span>self.workers_sync_tasks[worker_id].is_empty()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f;font-weight:700>return</span><span style=color:#bbb> </span>worker_id;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>!</span>self.workers_async_tasks[worker_id].is_empty()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f;font-weight:700>return</span><span style=color:#bbb> </span>worker_id;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>!</span>self.workers_completed_async_tasks[worker_id].is_empty()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f;font-weight:700>return</span><span style=color:#bbb> </span>worker_id;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>worker_id<span style=color:#bbb> </span><span style=color:#666>+=</span><span style=color:#bbb> </span><span style=color:#666>1</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>worker_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li><code>push_task</code>按照任务任务类型将<code>task</code>放到<code>worker</code>的对应任务队列中。</li><li><code>best_worker_id</code>从指定的<code>work_id</code>顺序检索有待处理任务的<code>work_id</code>。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>pop_worker_task</span>(<span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self,<span style=color:#bbb> </span>worker_id: <span style=color:#0b0;font-weight:700>usize</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#00f>ExecutorTask</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f>Some</span>(processor)<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.workers_sync_tasks[worker_id].pop_front()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>return</span><span style=color:#bbb> </span>ExecutorTask::<span style=color:#a2f>Sync</span>(processor);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f>Some</span>(task)<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.workers_completed_async_tasks[worker_id].pop_front()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>return</span><span style=color:#bbb> </span>ExecutorTask::AsyncCompleted(task);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f>Some</span>(processor)<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.workers_async_tasks[worker_id].pop_front()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>return</span><span style=color:#bbb> </span>ExecutorTask::Async(processor);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>ExecutorTask::<span style=color:#a2f>None</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>pop_task</span>(<span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self,<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>worker_id: <span style=color:#0b0;font-weight:700>usize</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#00f>ExecutorTask</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>for</span><span style=color:#bbb> </span>_index<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#666>..</span>self.workers_sync_tasks.len()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>match</span><span style=color:#bbb> </span>self.pop_worker_task(worker_id)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>ExecutorTask::<span style=color:#a2f>None</span><span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>worker_id<span style=color:#bbb> </span><span style=color:#666>+=</span><span style=color:#bbb> </span><span style=color:#666>1</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span>worker_id<span style=color:#bbb> </span><span style=color:#666>&gt;=</span><span style=color:#bbb> </span>self.workers_sync_tasks.len()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>worker_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>0</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>other<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>self.tasks_size<span style=color:#bbb> </span><span style=color:#666>-=</span><span style=color:#bbb> </span><span style=color:#666>1</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>return</span><span style=color:#bbb> </span>other;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>ExecutorTask::<span style=color:#a2f>None</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li><code>pop_worker_task</code>取出指定<code>worker_id</code>的任务或返回空。</li><li><code>pop_task</code>从指定的<code>worker_id</code>顺序检索任务或返回空。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>struct</span> <span style=color:#00f>ExecutorTasksQueue</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>finished: <span style=color:#00f>AtomicBool</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>workers_tasks: <span style=color:#00f>Mutex</span><span style=color:#666>&lt;</span>ExecutorTasks<span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>create</span>(workers_size: <span style=color:#0b0;font-weight:700>usize</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#00f>Arc</span><span style=color:#666>&lt;</span>ExecutorTasksQueue<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>Arc::new(ExecutorTasksQueue<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>finished: <span style=color:#00f>AtomicBool</span>::new(<span style=color:#a2f;font-weight:700>false</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>workers_tasks: <span style=color:#00f>Mutex</span>::new(ExecutorTasks::create(workers_size)),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>})<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>任务队列包装了一个<code>ExecutorTasks</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>init_tasks</span>(<span style=color:#666>&amp;</span>self,<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>tasks: <span style=color:#00f>VecDeque</span><span style=color:#666>&lt;</span>ExecutorTask<span style=color:#666>&gt;</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>worker_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>0</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>workers_tasks<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.workers_tasks.lock();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>while</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f>Some</span>(task)<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>tasks.pop_front()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>workers_tasks.push_task(worker_id,<span style=color:#bbb> </span>task);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>worker_id<span style=color:#bbb> </span><span style=color:#666>+=</span><span style=color:#bbb> </span><span style=color:#666>1</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span>worker_id<span style=color:#bbb> </span><span style=color:#666>==</span><span style=color:#bbb> </span>workers_tasks.workers_sync_tasks.len()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>worker_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>0</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p><code>init_tasks</code>方法将初始的任务，依次平均分配给每个<code>worker</code>，进入每个<code>worker</code>自己的相应队列。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>push_tasks</span>(<span style=color:#666>&amp;</span>self,<span style=color:#bbb> </span>ctx: <span style=color:#a2f>&amp;</span><span style=color:#00f>mut</span><span style=color:#bbb> </span>ExecutorWorkerContext,<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>tasks: <span style=color:#00f>VecDeque</span><span style=color:#666>&lt;</span>ExecutorTask<span style=color:#666>&gt;</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>wake_worker_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>None</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>worker_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>ctx.get_worker_num();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>workers_tasks<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.workers_tasks.lock();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>while</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f>Some</span>(task)<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>tasks.pop_front()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>workers_tasks.push_task(worker_id,<span style=color:#bbb> </span>task);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>wake_worker_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>Some</span>(workers_tasks.best_worker_id(worker_id<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#666>1</span>));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f>Some</span>(wake_worker_id)<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>wake_worker_id<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>ctx.get_workers_notify().wakeup(wake_worker_id);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p><code>push_tasks</code>方法将任务加入某一个<code>worker</code>，同时尝试唤醒紧接着的一个<code>worker</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>steal_task_to_context</span>(<span style=color:#666>&amp;</span>self,<span style=color:#bbb> </span>context: <span style=color:#a2f>&amp;</span><span style=color:#00f>mut</span><span style=color:#bbb> </span>ExecutorWorkerContext)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>workers_tasks<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.workers_tasks.lock();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>!</span>workers_tasks.is_empty()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>task<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>workers_tasks.pop_task(context.get_worker_num());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>is_async_task<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>matches!(<span style=color:#666>&amp;</span>task,<span style=color:#bbb> </span>ExecutorTask::Async(_));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>context.set_task(task);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>workers_notify<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>context.get_workers_notify();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span>is_async_task<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>workers_notify.inc_active_async_worker();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>!</span>workers_tasks.is_empty()<span style=color:#bbb> </span><span style=color:#666>&amp;&amp;</span><span style=color:#bbb> </span><span style=color:#666>!</span>workers_notify.is_empty()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>worker_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>context.get_worker_num();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>wakeup_worker_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>workers_tasks.best_worker_id(worker_id<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#666>1</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f>drop</span>(workers_tasks);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>workers_notify.wakeup(wakeup_worker_id);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>return</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic>// When tasks queue is empty and all workers are waiting, no new tasks will be generated.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>workers_notify<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>context.get_workers_notify();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>!</span>workers_notify.has_waiting_async_task()<span style=color:#bbb> </span><span style=color:#666>&amp;&amp;</span><span style=color:#bbb> </span>workers_notify.active_workers()<span style=color:#bbb> </span><span style=color:#666>&lt;=</span><span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f>drop</span>(workers_tasks);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>self.finish();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>workers_notify.wakeup_all();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>return</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f>drop</span>(workers_tasks);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>context.get_workers_notify().wait(context.get_worker_num());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p><em><strong>steal_task_to_context</strong></em>是一个关键方法，首先当还有待处理任务时，将任务拿到<code>context</code>对应的<code>worker</code>中，如果是异步任务，设置<code>inc_active_async_worker</code>
。然后再检查是否还有任务待处理，同时如果有空闲等待的<code>worker</code>，唤醒紧接当前<code>worker</code>的下一个<code>worker</code>。如果没有任务了，但是还有异步任务没有执行完或者还有其他其他的<code>worker</code>在执行中，当前<code>worker</code>
进入空闲等待状态，知道最后一个<code>worker</code>工作结束，设置<code>ExecutorTasksQueue</code>为完成，同时唤醒所有的<code>worker</code>。</p><h2 id=executorworkercontext><code>ExecutorWorkerContext</code> <a href=#executorworkercontext class=anchor>🔗</a></h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>enum</span> <span style=color:#00f>ExecutorTask</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#a2f>None</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#a2f>Sync</span>(ProcessorPtr),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>Async(ProcessorPtr),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic>// AsyncSchedule(ExecutingAsyncTask),
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#bbb>    </span>AsyncCompleted(CompletedAsyncTask),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>struct</span> <span style=color:#00f>ExecutorWorkerContext</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>worker_num: <span style=color:#0b0;font-weight:700>usize</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>task: <span style=color:#00f>ExecutorTask</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>workers_notify: <span style=color:#00f>Arc</span><span style=color:#666>&lt;</span>WorkersNotify<span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p><code>ExecutorWorkerContext</code>是每个<code>worker</code>执行的上下文。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>set_task</span>(<span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self,<span style=color:#bbb> </span>task: <span style=color:#00f>ExecutorTask</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>self.task<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>task<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>take_task</span>(<span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self)<span style=color:#bbb> </span>-&gt; <span style=color:#00f>ExecutorTask</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>std::mem::replace(<span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self.task,<span style=color:#bbb> </span>ExecutorTask::<span style=color:#a2f>None</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>unsafe</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>execute_task</span>(<span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self,<span style=color:#bbb> </span>exec: <span style=color:#a2f>&amp;</span><span style=color:#00f>PipelineExecutor</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#a2f>Result</span><span style=color:#666>&lt;</span><span style=color:#a2f>Option</span><span style=color:#666>&lt;</span>NodeIndex<span style=color:#666>&gt;&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>match</span><span style=color:#bbb> </span>std::mem::replace(<span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self.task,<span style=color:#bbb> </span>ExecutorTask::<span style=color:#a2f>None</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>ExecutorTask::<span style=color:#a2f>None</span><span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#a2f>Err</span>(ErrorCode::LogicalError(<span style=color:#b44>&#34;Execute none task.&#34;</span>)),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>ExecutorTask::<span style=color:#a2f>Sync</span>(processor)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>self.execute_sync_task(processor),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>ExecutorTask::Async(processor)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>self.execute_async_task(processor,<span style=color:#bbb> </span>exec),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>ExecutorTask::AsyncCompleted(task)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>match</span><span style=color:#bbb> </span>task.res<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f>Ok</span>(_)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#a2f>Ok</span>(<span style=color:#a2f>Some</span>(task.id)),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f>Err</span>(cause)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#a2f>Err</span>(cause),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>unsafe</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>execute_sync_task</span>(<span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self,<span style=color:#bbb> </span>processor: <span style=color:#00f>ProcessorPtr</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#a2f>Result</span><span style=color:#666>&lt;</span><span style=color:#a2f>Option</span><span style=color:#666>&lt;</span>NodeIndex<span style=color:#666>&gt;&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>processor.process()<span style=color:#666>?</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f>Ok</span>(<span style=color:#a2f>Some</span>(processor.id()))<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>unsafe</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>execute_async_task</span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>self,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>processor: <span style=color:#00f>ProcessorPtr</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>executor: <span style=color:#a2f>&amp;</span><span style=color:#00f>PipelineExecutor</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span>-&gt; <span style=color:#a2f>Result</span><span style=color:#666>&lt;</span><span style=color:#a2f>Option</span><span style=color:#666>&lt;</span>NodeIndex<span style=color:#666>&gt;&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>worker_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.worker_num;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>workers_notify<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.get_workers_notify().clone();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>tasks_queue<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>executor.global_tasks_queue.clone();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>executor.async_runtime.spawn(<span style=color:#a2f;font-weight:700>async</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>move</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>res<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>processor.async_process().<span style=color:#a2f;font-weight:700>await</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>task<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>CompletedAsyncTask::create(processor,<span style=color:#bbb> </span>worker_id,<span style=color:#bbb> </span>res);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>tasks_queue.completed_async_task(task);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>workers_notify.dec_active_async_worker();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>workers_notify.wakeup(worker_id);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>});<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f>Ok</span>(<span style=color:#a2f>None</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>核心的方法是<code>set_task</code>和<code>execute_task</code>。</p><ul><li><code>set_task</code>为当前<code>worker</code>获取了一个任务。</li><li><code>execute_task</code>则是实际实际当前的任务，若任务是一个异步任务，则交由异步运行时实际执行，执行后将结果包装成<code>ExecutorTask::AsyncCompleted</code>任务，放入全局任务队列。同时唤醒<code>worker</code>
，如果当前<code>worker</code>在等待中则唤醒当前<code>worker</code>，如果当前<code>worker</code>没有在等待，则轮询等待中的<code>worker</code>，直到唤醒一个为止。</li></ul><h2 id=executor-notify><code>Executor notify</code> <a href=#executor-notify class=anchor>🔗</a></h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>struct</span> <span style=color:#00f>WorkerNotify</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>waiting: <span style=color:#00f>Mutex</span><span style=color:#666>&lt;</span><span style=color:#0b0;font-weight:700>bool</span><span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>condvar: <span style=color:#00f>Condvar</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>impl</span><span style=color:#bbb> </span>WorkerNotify<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>create</span>()<span style=color:#bbb> </span>-&gt; <span style=color:#00f>WorkerNotify</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>WorkerNotify<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>waiting: <span style=color:#00f>Mutex</span>::new(<span style=color:#a2f;font-weight:700>false</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>condvar: <span style=color:#00f>Condvar</span>::create(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>struct</span> <span style=color:#00f>WorkersNotifyMutable</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span>waiting_size: <span style=color:#0b0;font-weight:700>usize</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span>workers_waiting: <span style=color:#a2f>Vec</span><span style=color:#666>&lt;</span><span style=color:#0b0;font-weight:700>bool</span><span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>struct</span> <span style=color:#00f>WorkersNotify</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>workers: <span style=color:#0b0;font-weight:700>usize</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>waiting_async_task: <span style=color:#00f>AtomicUsize</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>mutable_state: <span style=color:#00f>Mutex</span><span style=color:#666>&lt;</span>WorkersNotifyMutable<span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>workers_notify: <span style=color:#a2f>Vec</span><span style=color:#666>&lt;</span>WorkerNotify<span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li><code>WorkerNotify</code>构建一个条件变量，表示<code>worker</code>是否空闲等待。</li><li><code>WorkersNotify</code>用于保存哪些<code>worker</code>在空闲等待，通过<code>Vec</code>的<code>index</code>来关联指定的<code>worker</code>，同时记录在处理中的异步任务数。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>wakeup</span>(<span style=color:#666>&amp;</span>self,<span style=color:#bbb> </span>worker_id: <span style=color:#0b0;font-weight:700>usize</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>mutable_state<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.mutable_state.lock();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span>mutable_state.waiting_size<span style=color:#bbb> </span><span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>mutable_state.waiting_size<span style=color:#bbb> </span><span style=color:#666>-=</span><span style=color:#bbb> </span><span style=color:#666>1</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span>mutable_state.workers_waiting[worker_id]<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>mutable_state.workers_waiting[worker_id]<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>waiting<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.workers_notify[worker_id].waiting.lock();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#666>*</span>waiting<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f>drop</span>(mutable_state);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>self.workers_notify[worker_id].condvar.notify_one();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>else</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f;font-weight:700>for</span><span style=color:#bbb> </span>(index,<span style=color:#bbb> </span>waiting)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span>mutable_state.workers_waiting.iter().enumerate()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>*</span>waiting<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>mutable_state.workers_waiting[index]<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>waiting<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.workers_notify[index].waiting.lock();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#666>*</span>waiting<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f>drop</span>(mutable_state);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>self.workers_notify[index].condvar.notify_one();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>return</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>wakeup_all</span>(<span style=color:#666>&amp;</span>self)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>mutable_state<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.mutable_state.lock();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span>mutable_state.waiting_size<span style=color:#bbb> </span><span style=color:#666>&gt;</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>mutable_state.waiting_size<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>0</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>for</span><span style=color:#bbb> </span>index<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#666>..</span>mutable_state.workers_waiting.len()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>mutable_state.workers_waiting[index]<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f>drop</span>(mutable_state);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>for</span><span style=color:#bbb> </span>index<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#666>..</span>self.workers_notify.len()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>waiting<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.workers_notify[index].waiting.lock();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>*</span>waiting<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#666>*</span>waiting<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>self.workers_notify[index].condvar.notify_one();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>wait</span>(<span style=color:#666>&amp;</span>self,<span style=color:#bbb> </span>worker_id: <span style=color:#0b0;font-weight:700>usize</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>mutable_state<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.mutable_state.lock();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>mutable_state.waiting_size<span style=color:#bbb> </span><span style=color:#666>+=</span><span style=color:#bbb> </span><span style=color:#666>1</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>mutable_state.workers_waiting[worker_id]<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>waiting<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.workers_notify[worker_id].waiting.lock();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#666>*</span>waiting<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f>drop</span>(mutable_state);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>self.workers_notify[worker_id].condvar.wait(<span style=color:#666>&amp;</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>waiting);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li><code>wakeup</code>唤醒空闲等待的<code>worker</code>，如果指定的<code>worker</code>已经被唤醒，则轮询等待中的<code>worker</code>，知道唤醒一个位置。</li><li><code>wakeup_all</code>只要有空闲等待的<code>worker</code>则全部唤醒。</li><li><code>wait</code>使指定的<code>worker</code>空闲等待。</li></ul><h2 id=port><code>Port</code> <a href=#port class=anchor>🔗</a></h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>const</span><span style=color:#bbb> </span>HAS_DATA: <span style=color:#0b0;font-weight:700>usize</span> <span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>0b1</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>const</span><span style=color:#bbb> </span>NEED_DATA: <span style=color:#0b0;font-weight:700>usize</span> <span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>0b10</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>const</span><span style=color:#bbb> </span>IS_FINISHED: <span style=color:#0b0;font-weight:700>usize</span> <span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>0b100</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>const</span><span style=color:#bbb> </span>FLAGS_MASK: <span style=color:#0b0;font-weight:700>usize</span> <span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>0b111</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>const</span><span style=color:#bbb> </span>UNSET_FLAGS_MASK: <span style=color:#0b0;font-weight:700>usize</span> <span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#666>!</span>FLAGS_MASK;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080>#[repr(align(8))]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>struct</span> <span style=color:#00f>SharedData</span>(<span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f>Result</span><span style=color:#666>&lt;</span>DataBlock<span style=color:#666>&gt;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>struct</span> <span style=color:#00f>SharedStatus</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>data: <span style=color:#00f>AtomicPtr</span><span style=color:#666>&lt;</span>SharedData<span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p><code>port</code>中核心的数据结构是<code>SharedStatus</code>，使用原子指针来在多线程中共享<code>SharedData</code>，<code>SharedData</code>是一个<code>DataBlock</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>swap</span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#666>&amp;</span>self,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>data: <span style=color:#666>*</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>SharedData,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>set_flags: <span style=color:#0b0;font-weight:700>usize</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>unset_flags: <span style=color:#0b0;font-weight:700>usize</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>)<span style=color:#bbb> </span>-&gt; <span style=color:#666>*</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>SharedData<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>expected<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>std::ptr::null_mut();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>desired<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>(data<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>usize</span><span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>set_flags)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>SharedData;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>loop</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>match</span><span style=color:#bbb> </span>self.data.compare_exchange_weak(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>expected,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>desired,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>Ordering::SeqCst,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>Ordering::Relaxed,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f>Err</span>(new_expected)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>expected<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>new_expected;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>address<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>expected<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>usize</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>desired_data<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>desired<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>usize</span><span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span>UNSET_FLAGS_MASK;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>desired_flags<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>(address<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span>FLAGS_MASK<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span><span style=color:#666>!</span>unset_flags)<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>set_flags;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>desired<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>(desired_data<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>desired_flags)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>SharedData;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f>Ok</span>(old_value)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>old_value_ptr<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>old_value<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>usize</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>return</span><span style=color:#bbb> </span>(old_value_ptr<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span>UNSET_FLAGS_MASK)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>SharedData;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>set_flags</span>(<span style=color:#666>&amp;</span>self,<span style=color:#bbb> </span>set_flags: <span style=color:#0b0;font-weight:700>usize</span>,<span style=color:#bbb> </span>unset_flags: <span style=color:#0b0;font-weight:700>usize</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#0b0;font-weight:700>usize</span> {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>expected<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>std::ptr::null_mut();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>desired<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>set_flags<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>SharedData;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>loop</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>match</span><span style=color:#bbb> </span>self.data.compare_exchange_weak(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>expected,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>desired,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>Ordering::SeqCst,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>Ordering::Relaxed,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f>Ok</span>(old_value)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>return</span><span style=color:#bbb> </span>old_value<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>usize</span><span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span>FLAGS_MASK;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#a2f>Err</span>(new_expected)<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>expected<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>new_expected;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>address<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>expected<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>usize</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>desired_data<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>address<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span>UNSET_FLAGS_MASK;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>desired_flags<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>(address<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span>FLAGS_MASK<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span><span style=color:#666>!</span>unset_flags)<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>set_flags;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>desired<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>(desired_data<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>desired_flags)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>SharedData;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#080>#[inline(always)]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>get_flags</span>(<span style=color:#666>&amp;</span>self)<span style=color:#bbb> </span>-&gt; <span style=color:#0b0;font-weight:700>usize</span> {<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>self.data.load(Ordering::Relaxed)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#0b0;font-weight:700>usize</span><span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span>FLAGS_MASK<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p><code>port</code>中使用交换指针地址而非实际数据来减少内存的复制，同时复用指针地址的低三位来标识状态，实际的指针地址和状态可以通过<code>mask</code>来得出实际的值。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>struct</span> <span style=color:#00f>InputPort</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>shared: <span style=color:#00f>UnSafeCellWrap</span><span style=color:#666>&lt;</span>Arc<span style=color:#666>&lt;</span>SharedStatus<span style=color:#666>&gt;&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>update_trigger: <span style=color:#00f>UnSafeCellWrap</span><span style=color:#666>&lt;*</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>UpdateTrigger<span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>pull_data</span>(<span style=color:#666>&amp;</span>self)<span style=color:#bbb> </span>-&gt; <span style=color:#a2f>Option</span><span style=color:#666>&lt;</span><span style=color:#a2f>Result</span><span style=color:#666>&lt;</span>DataBlock<span style=color:#666>&gt;&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>UpdateTrigger::update_input(<span style=color:#666>&amp;</span>self.update_trigger);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>unset_flags<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>HAS_DATA<span style=color:#bbb> </span><span style=color:#666>|</span><span style=color:#bbb> </span>NEED_DATA;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>match</span><span style=color:#bbb> </span>self.shared.swap(std::ptr::null_mut(),<span style=color:#bbb> </span><span style=color:#666>0</span>,<span style=color:#bbb> </span>unset_flags)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>address<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span>address.is_null()<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#a2f>None</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>address<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#a2f>Some</span>((<span style=color:#666>*</span><span style=color:#a2f>Box</span>::from_raw(address)).<span style=color:#666>0</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>set_need_data</span>(<span style=color:#666>&amp;</span>self)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>flags<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.shared.set_flags(NEED_DATA,<span style=color:#bbb> </span>NEED_DATA);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span>flags<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span>NEED_DATA<span style=color:#bbb> </span><span style=color:#666>==</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>UpdateTrigger::update_input(<span style=color:#666>&amp;</span>self.update_trigger);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>finish</span>(<span style=color:#666>&amp;</span>self)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>flags<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.shared.set_flags(IS_FINISHED,<span style=color:#bbb> </span>IS_FINISHED);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span>flags<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span>IS_FINISHED<span style=color:#bbb> </span><span style=color:#666>==</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>UpdateTrigger::update_input(<span style=color:#666>&amp;</span>self.update_trigger);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>struct</span> <span style=color:#00f>OutputPort</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>shared: <span style=color:#00f>UnSafeCellWrap</span><span style=color:#666>&lt;</span>Arc<span style=color:#666>&lt;</span>SharedStatus<span style=color:#666>&gt;&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>update_trigger: <span style=color:#00f>UnSafeCellWrap</span><span style=color:#666>&lt;*</span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>UpdateTrigger<span style=color:#666>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>push_data</span>(<span style=color:#666>&amp;</span>self,<span style=color:#bbb> </span>data: <span style=color:#a2f>Result</span><span style=color:#666>&lt;</span>DataBlock<span style=color:#666>&gt;</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>UpdateTrigger::update_output(<span style=color:#666>&amp;</span>self.update_trigger);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>data<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>Box</span>::into_raw(<span style=color:#a2f>Box</span>::new(SharedData(data)));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>self.shared.swap(data,<span style=color:#bbb> </span>HAS_DATA,<span style=color:#bbb> </span>HAS_DATA);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>finish</span>(<span style=color:#666>&amp;</span>self)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>flags<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.shared.set_flags(IS_FINISHED,<span style=color:#bbb> </span>IS_FINISHED);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span>flags<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#bbb> </span>IS_FINISHED<span style=color:#bbb> </span><span style=color:#666>==</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>UpdateTrigger::update_output(<span style=color:#666>&amp;</span>self.update_trigger);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>unsafe</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>connect</span>(input: <span style=color:#a2f>&amp;</span><span style=color:#00f>InputPort</span>,<span style=color:#bbb> </span>output: <span style=color:#a2f>&amp;</span><span style=color:#00f>OutputPort</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>shared_status<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>SharedStatus::create();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>input.set_shared(shared_status.clone());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>output.set_shared(shared_status);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><ul><li><code>pull_data</code>方法会改变<code>input_port</code>中的数据，<code>set_need_data</code>和<code>finish</code>会改变<code>port</code>的状态，三个方法都会触发<code>trigger</code>，实际会<code>push</code>
一个<code>DirectedEdge::Target</code>到全局的<code>updated_edges</code>中。</li><li><code>push_data</code>方法会改变<code>output_port</code>中的数据，<code>finish</code>会改变<code>port</code>的状态，两个方法都会触发<code>trigger</code>,实际会<code>push</code>一个<code>DirectedEdge::Source</code>
到全局的<code>updated_edges</code>中。</li><li><code>connect</code>是一个<code>input_port</code>和一个<code>output_port</code>可以共享同一个<code>SharedStatus</code>。</li></ul><h2 id=execute-graph><code>Execute Graph</code> <a href=#execute-graph class=anchor>🔗</a></h2><p>整个<code>pipeline</code>的<code>pipes</code>会循环迭代所有的<code>processor</code>和<code>input_port</code>,<code>output_port</code>，构建成<code>graph</code>的<code>node</code>和<code>edge</code>。同时在<code>node</code>上会创建<code>input_port</code>
和<code>output_port</code>的触发器，触发器会触发<code>edge</code>被调度，而后就会调度到原节点的上下游节点。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#a2f;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>fn</span> <span style=color:#00a000>create</span>(pipeline: <span style=color:#00f>NewPipeline</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#a2f>Result</span><span style=color:#666>&lt;</span>ExecutingGraph<span style=color:#666>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic>// let (nodes_size, edges_size) = pipeline.graph_size();
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>graph<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>StableGraph::new();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>node_stack<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>Vec</span>::new();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>edge_stack: <span style=color:#a2f>Vec</span><span style=color:#666>&lt;</span>Arc<span style=color:#666>&lt;</span>OutputPort<span style=color:#666>&gt;&gt;</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>Vec</span>::new();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f;font-weight:700>for</span><span style=color:#bbb> </span>query_pipe<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span><span style=color:#666>&amp;</span>pipeline.pipes<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#a2f;font-weight:700>match</span><span style=color:#bbb> </span>query_pipe<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>NewPipe::ResizePipe<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>processor,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>inputs_port,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>outputs_port,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>}<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>assert_eq!(node_stack.len(),<span style=color:#bbb> </span>inputs_port.len());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>resize_node<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>Node::create(processor,<span style=color:#bbb> </span>inputs_port,<span style=color:#bbb> </span>outputs_port);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>target_index<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>graph.add_node(resize_node.clone());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>processor.set_id(target_index);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>for</span><span style=color:#bbb> </span>index<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#666>..</span>node_stack.len()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>source_index<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>node_stack[index];<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>edge_index<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>graph.add_edge(source_index,<span style=color:#bbb> </span>target_index,<span style=color:#bbb> </span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>input_trigger<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>resize_node.create_trigger(edge_index);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>inputs_port[index].set_trigger(input_trigger);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>edge_stack[index]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span>.set_trigger(graph[source_index].create_trigger(edge_index));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>connect(<span style=color:#666>&amp;</span>inputs_port[index],<span style=color:#bbb> </span><span style=color:#666>&amp;</span>edge_stack[index]);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>node_stack.clear();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>edge_stack.clear();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>for</span><span style=color:#bbb> </span>output_port<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span>outputs_port<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>node_stack.push(target_index);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>edge_stack.push(output_port.clone());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>NewPipe::SimplePipe<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>processors,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>inputs_port,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>outputs_port,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>}<span style=color:#bbb> </span><span style=color:#666>=&gt;</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>assert_eq!(node_stack.len(),<span style=color:#bbb> </span>inputs_port.len());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>assert!(inputs_port.is_empty()<span style=color:#bbb> </span><span style=color:#666>||</span><span style=color:#bbb> </span>inputs_port.len()<span style=color:#bbb> </span><span style=color:#666>==</span><span style=color:#bbb> </span>processors.len());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>assert!(outputs_port.is_empty()<span style=color:#bbb> </span><span style=color:#666>||</span><span style=color:#bbb> </span>outputs_port.len()<span style=color:#bbb> </span><span style=color:#666>==</span><span style=color:#bbb> </span>processors.len());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>new_node_stack<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>Vec</span>::with_capacity(outputs_port.len());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>new_edge_stack<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>Vec</span>::with_capacity(outputs_port.len());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#a2f;font-weight:700>for</span><span style=color:#bbb> </span>index<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>in</span><span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#666>..</span>processors.len()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>p_inputs_port<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>Vec</span>::with_capacity(<span style=color:#666>1</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>mut</span><span style=color:#bbb> </span>p_outputs_port<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#a2f>Vec</span>::with_capacity(<span style=color:#666>1</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>!</span>inputs_port.is_empty()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span>p_inputs_port.push(inputs_port[index].clone());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>!</span>outputs_port.is_empty()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span>p_outputs_port.push(outputs_port[index].clone());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>target_node<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span>Node::create(<span style=color:#666>&amp;</span>processors[index],<span style=color:#bbb> </span><span style=color:#666>&amp;</span>p_inputs_port,<span style=color:#bbb> </span><span style=color:#666>&amp;</span>p_outputs_port);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>target_index<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>graph.add_node(target_node.clone());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>processors[index].set_id(target_index);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>!</span>node_stack.is_empty()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>source_index<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>node_stack[index];<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span><span style=color:#a2f;font-weight:700>let</span><span style=color:#bbb> </span>edge_index<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>graph.add_edge(source_index,<span style=color:#bbb> </span>target_index,<span style=color:#bbb> </span>());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span>inputs_port[index].set_trigger(target_node.create_trigger(edge_index));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span>edge_stack[index]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                                </span>.set_trigger(graph[source_index].create_trigger(edge_index));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span>connect(<span style=color:#666>&amp;</span>inputs_port[index],<span style=color:#bbb> </span><span style=color:#666>&amp;</span>edge_stack[index]);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#a2f;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#666>!</span>outputs_port.is_empty()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span>new_node_stack.push(target_index);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                            </span>new_edge_stack.push(outputs_port[index].clone());<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>node_stack<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>new_node_stack;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>edge_stack<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>new_edge_stack;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic>// Assert no output.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#bbb>        </span>assert_eq!(node_stack.len(),<span style=color:#bbb> </span><span style=color:#666>0</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#a2f>Ok</span>(ExecutingGraph<span style=color:#bbb> </span>{<span style=color:#bbb> </span>graph<span style=color:#bbb> </span>})<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div></div><div class=tags><a href=https://grapebaba.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93>数据库</a>
<a href=https://grapebaba.github.io/tags/dag>DAG</a>
<a href=https://grapebaba.github.io/tags/pipeline>pipeline</a></div><div id=comment><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//grapebaba.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/GrapeBaBa rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a><a class=symbol href=https://stackoverflow.com/users/3141951/grapebaba rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>stackoverflow</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-488.000000, -1163.000000)"><g id="stackoverflow" transform="translate(488.000000, 1163.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M42.0860128 53.5922927 22.9745951 53.6011499 22.9729497 49.5538824 42.0835447 49.5440929 42.0860128 53.5922927zM55 30.6708298 51.7306912 12 47.7087256 12.6920259l3.2688387 18.6708298L55 30.6708298zM42.5455518 44.3547147 23.5156994 42.616026 23.1410164 46.6470941l19.030205 1.7370572L42.5455518 44.3547147zm1.2554466-5.2815628-18.4550173-4.919234L24.285633 38.0621508l18.4563101 4.9198168 1.0590553-3.9088157zm2.4093479-4.6295108-16.4608999-9.6271776-2.0746249 3.4850693 16.4617226 9.6277603 2.0738022-3.485652zm4.0363041-2.8347655-3.3721468 2.2794433L36.106599 18.2318456l3.3726169-2.2801425L50.2466504 31.6088756zm-4.9150697 8.6695527h3.2483886V60H17V40.2784283h3.2648427V56.8243495h25.066738V40.2784283z" fill="#fff"/></g></g></g></svg></a><a class=symbol href=https://twitter.com/GrapeBaBa rel=me target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg></a></div><div class=copyright>© Copyright
2023
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Grapebaba</div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>